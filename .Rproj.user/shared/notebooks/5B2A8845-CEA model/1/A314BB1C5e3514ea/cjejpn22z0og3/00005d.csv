"0","# Install and load packages"
"0","#install.packages(""heemod"")"
"0","library(heemod)"
"2","Warning:"
"2"," package â€˜heemodâ€™ was built under R version 4.4.3
"
"0","library(tidyverse)"
"2","Warning:"
"2"," package â€˜tidyverseâ€™ was built under R version 4.4.2
"
"1","â”€â”€ [1mAttaching core tidyverse packages[22m â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse 2.0.0 â”€â”€
[32mâœ”[39m [34mdplyr    [39m 1.1.4     [32mâœ”[39m [34mreadr    [39m 2.1.5
[32mâœ”[39m [34mforcats  [39m 1.0.0     [32mâœ”[39m [34mstringr  [39m 1.5.1
[32mâœ”[39m [34mggplot2  [39m 3.5.1     [32mâœ”[39m [34mtibble   [39m 3.2.1
[32mâœ”[39m [34mlubridate[39m 1.9.3     [32mâœ”[39m [34mtidyr    [39m 1.3.1
[32mâœ”[39m [34mpurrr    [39m 1.0.2     
"
"1","â”€â”€ [1mConflicts[22m â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse_conflicts() â”€â”€
[31mâœ–[39m [34mdplyr[39m::[32mfilter()[39m masks [34mstats[39m::filter()
[31mâœ–[39m [34mdplyr[39m::[32mlag()[39m    masks [34mstats[39m::lag()
[31mâœ–[39m [34mpurrr[39m::[32mmodify()[39m masks [34mheemod[39m::modify()
[36mâ„¹[39m Use the ]8;;http://conflicted.r-lib.org/conflicted package]8;; to force all conflicts to become errors
"
"0","# Load dataset"
"0","data <- read_csv(""healthexpenditure.csv"") # Replace with your Kaggle CSV path"
"1","[1mRows: [22m[34m2955[39m [1mColumns: [22m[34m8[39m
"
"1","[36mâ”€â”€[39m [1mColumn specification[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
[1mDelimiter:[22m "",""
[32mdbl[39m (8): dupersid, totexp, ltotexp, suppins, totchr, age, female, white
"
"1","
[36mâ„¹[39m Use `spec()` to retrieve the full column specification for this data.
[36mâ„¹[39m Specify the column types or set `show_col_types = FALSE` to quiet this message.
"
"0","# Combine totchr 4â€“7 into a single category"
"0","data <- data %>%"
"0","  mutate(totchr_grouped = pmin(totchr, 4)) # Caps totchr at 4 (4, 5, 6, 7 become â‰¥4)"
"0",""
"0","# Calculate average costs by totchr_grouped"
"0","cost_data <- data %>%"
"0","  group_by(totchr_grouped) %>%"
"0","  summarise(avg_cost = mean(totexp, na.rm = TRUE))"
"0",""
"0","# Check for NA or non-numeric values in costs"
"0","print(""Cost data summary:"")"
"1","[1]"
"1"," ""Cost data summary:"""
"1","
"
"0","print(summary(cost_data$avg_cost))"
"1","   Min. "
"1","1st Qu. "
"1"," Median "
"1","   Mean "
"1","3rd Qu. "
"1","   Max. "
"1","
"
"1","   2983 "
"1","   5356 "
"1","   7167 "
"1","   8013 "
"1","  10830 "
"1","  13726 "
"1","
"
"0","if (any(is.na(cost_data$avg_cost))) stop(""NA values found in cost_data$avg_cost"")"
"0","if (length(cost_data$avg_cost) != 5) stop(""cost_data$avg_cost does not have exactly 5 values"")"
"0",""
"0","# Define QALYs for each state (adjusted for ages 60â€“90)"
"0","qaly_data <- tibble("
"0","  totchr_grouped = 0:4,"
"0","  QALY = c(0.90, 0.80, 0.70, 0.60, 0.45) # Lower QALYs for older adults"
"0",")"
"0",""
"0","# Check for NA or non-numeric values in QALYs"
"0","print(""QALY data summary:"")"
"1","[1]"
"1"," ""QALY data summary:"""
"1","
"
"0","print(summary(qaly_data$QALY))"
"1","   Min. "
"1","1st Qu. "
"1"," Median "
"1","   Mean "
"1","3rd Qu. "
"1","   Max. "
"1","
"
"1","   0.45 "
"1","   0.60 "
"1","   0.70 "
"1","   0.69 "
"1","   0.80 "
"1","   0.90 "
"1","
"
"0","if (any(is.na(qaly_data$QALY))) stop(""NA values found in qaly_data$QALY"")"
"0","if (length(qaly_data$QALY) != 5) stop(""qaly_data$QALY does not have exactly 5 values"")"
"0",""
"0","# Define parameters for costs and effects"
"0","params <- define_parameters("
"0","  cost_totchr_0 = cost_data$avg_cost[1],"
"0","  cost_totchr_1 = cost_data$avg_cost[2],"
"0","  cost_totchr_2 = cost_data$avg_cost[3],"
"0","  cost_totchr_3 = cost_data$avg_cost[4],"
"0","  cost_totchr_geq4 = cost_data$avg_cost[5],"
"0","  QALY_totchr_0 = qaly_data$QALY[1],"
"0","  QALY_totchr_1 = qaly_data$QALY[2],"
"0","  QALY_totchr_2 = qaly_data$QALY[3],"
"0","  QALY_totchr_3 = qaly_data$QALY[4],"
"0","  QALY_totchr_geq4 = qaly_data$QALY[5],"
"0","  cost_dead = 0,"
"0","  QALY_dead = 0"
"0",")"
"0",""
"0","# Debug: Check parameters object"
"0","print(""Parameters object:"")"
"1","[1]"
"1"," ""Parameters object:"""
"1","
"
"0","print(params)"
"1","12 unevaluated parameters.

"
"1","cost_totchr_0 = cost_data$avg_cost[1]"
"1","
"
"1","cost_totchr_1 = cost_data$avg_cost[2]"
"1","
"
"1","cost_totchr_2 = cost_data$avg_cost[3]"
"1","
"
"1","cost_totchr_3 = cost_data$avg_cost[4]"
"1","
"
"1","cost_totchr_geq4 = cost_data$avg_cost[5]"
"1","
"
"1","QALY_totchr_0 = qaly_data$QALY[1]"
"1","
"
"1","QALY_totchr_1 = qaly_data$QALY[2]"
"1","
"
"1","QALY_totchr_2 = qaly_data$QALY[3]"
"1","
"
"1","QALY_totchr_3 = qaly_data$QALY[4]"
"1","
"
"1","QALY_totchr_geq4 = qaly_data$QALY[5]"
"1","
"
"1","cost_dead = 0"
"1","
"
"1","QALY_dead = 0"
"1","
"
"0","# Define state names"
"0","state_names <- c(""totchr_0"", ""totchr_1"", ""totchr_2"", ""totchr_3"", ""totchr_geq4"", ""Dead"")"
"0",""
"0","# Define states using parameters"
"0","state_totchr_0 <- define_state(cost = cost_totchr_0, effect = QALY_totchr_0)"
"0","state_totchr_1 <- define_state(cost = cost_totchr_1, effect = QALY_totchr_1)"
"0","state_totchr_2 <- define_state(cost = cost_totchr_2, effect = QALY_totchr_2)"
"0","state_totchr_3 <- define_state(cost = cost_totchr_3, effect = QALY_totchr_3)"
"0","state_totchr_geq4 <- define_state(cost = cost_totchr_geq4, effect = QALY_totchr_geq4)"
"0","state_dead <- define_state(cost = cost_dead, effect = QALY_dead)"
"0",""
"0","# Debug: Check state objects before define_strategy"
"0","print(""Checking state objects:"")"
"1","[1]"
"1"," ""Checking state objects:"""
"1","
"
"0","print(state_totchr_0)"
"1","A state with 2 values.

"
"1","cost = cost_totchr_0"
"1","
"
"1","effect = QALY_totchr_0"
"1","
"
"0","print(state_totchr_1)"
"1","A state with 2 values.

"
"1","cost = cost_totchr_1"
"1","
"
"1","effect = QALY_totchr_1"
"1","
"
"0","print(state_totchr_2)"
"1","A state with 2 values.

"
"1","cost = cost_totchr_2"
"1","
"
"1","effect = QALY_totchr_2"
"1","
"
"0","print(state_totchr_3)"
"1","A state with 2 values.

"
"1","cost = cost_totchr_3"
"1","
"
"1","effect = QALY_totchr_3"
"1","
"
"0","print(state_totchr_geq4)"
"1","A state with 2 values.

"
"1","cost = cost_totchr_geq4"
"1","
"
"1","effect = QALY_totchr_geq4"
"1","
"
"0","print(state_dead)"
"1","A state with 2 values.

"
"1","cost = cost_dead"
"1","
"
"1","effect = QALY_dead"
"1","
"
"0","# Clean up unexpected variables"
"0","rm(list = c(""dead"", ""Dead"", ""totchr_0"", ""totchr_1"", ""totchr_2"", ""totchr_3"", ""totchr_geq4"", ""trans_mat"", ""trans_mat2""), envir = .GlobalEnv)"
"2","Warning in rm(list = c(""dead"", ""Dead"", ""totchr_0"", ""totchr_1"", ""totchr_2"",  :"
"2","
 "
"2"," object 'dead' not found
"
"2","Warning in rm(list = c(""dead"", ""Dead"", ""totchr_0"", ""totchr_1"", ""totchr_2"",  :"
"2","
 "
"2"," object 'Dead' not found
"
"2","Warning in rm(list = c(""dead"", ""Dead"", ""totchr_0"", ""totchr_1"", ""totchr_2"",  :"
"2","
 "
"2"," object 'totchr_0' not found
"
"2","Warning in rm(list = c(""dead"", ""Dead"", ""totchr_0"", ""totchr_1"", ""totchr_2"",  :"
"2","
 "
"2"," object 'totchr_1' not found
"
"2","Warning in rm(list = c(""dead"", ""Dead"", ""totchr_0"", ""totchr_1"", ""totchr_2"",  :"
"2","
 "
"2"," object 'totchr_2' not found
"
"2","Warning in rm(list = c(""dead"", ""Dead"", ""totchr_0"", ""totchr_1"", ""totchr_2"",  :"
"2","
 "
"2"," object 'totchr_3' not found
"
"2","Warning in rm(list = c(""dead"", ""Dead"", ""totchr_0"", ""totchr_1"", ""totchr_2"",  :"
"2","
 "
"2"," object 'totchr_geq4' not found
"
"2","Warning in rm(list = c(""dead"", ""Dead"", ""totchr_0"", ""totchr_1"", ""totchr_2"",  :"
"2","
 "
"2"," object 'trans_mat' not found
"
"2","Warning in rm(list = c(""dead"", ""Dead"", ""totchr_0"", ""totchr_1"", ""totchr_2"",  :"
"2","
 "
"2"," object 'trans_mat2' not found
"
"0","# Debug: Check environment variables after cleanup"
"0","print(""Environment variables after cleanup:"")"
"1","[1]"
"1"," ""Environment variables after cleanup:"""
"1","
"
"0","print(ls())"
"1"," [1]"
"1"," ""cost_data""         "
"1"," ""data""              "
"1"," ""model_intervention"""
"1","
"
"1"," [4]"
"1"," ""model_standard""    "
"1"," ""params""            "
"1"," ""psa""               "
"1","
"
"1"," [7]"
"1"," ""qaly_data""         "
"1"," ""res_psa""           "
"1"," ""result""            "
"1","
"
"1","[10]"
"1"," ""s""                 "
"1"," ""state_dead""        "
"1"," ""state_names""       "
"1","
"
"1","[13]"
"1"," ""state_totchr_0""    "
"1"," ""state_totchr_1""    "
"1"," ""state_totchr_2""    "
"1","
"
"1","[16]"
"1"," ""state_totchr_3""    "
"1"," ""state_totchr_geq4"" "
"1"," ""trans_intervention"""
"1","
"
"1","[19]"
"1"," ""trans_standard""    "
"1","
"
"0","# Transition matrix (standard care) with state names"
"0","trans_standard <- define_transition("
"0","  0.75, 0.15, 0,    0,    0,    0.10,  # totchr_0"
"0","  0.05, 0.70, 0.10, 0,    0,    0.15,  # totchr_1"
"0","  0,    0.05, 0.68, 0.12, 0,    0.15,  # totchr_2"
"0","  0,    0,    0.05, 0.65, 0.15, 0.15,  # totchr_3"
"0","  0,    0,    0,    0.05, 0.70, 0.25,  # totchr_geq4"
"0","  0,    0,    0,    0,    0,    1.00,  # Dead"
"0","  state_names = state_names"
"0",")"
"0",""
"0","# Debug: Check transition matrix"
"0","print(""Transition matrix (standard):"")"
"1","[1]"
"1"," ""Transition matrix (standard):"""
"1","
"
"0","print(trans_standard)"
"1","A transition matrix, 6 states.

"
"1","           "
"1"," totchr_0"
"1"," totchr_1"
"1"," totchr_2"
"1"," totchr_3"
"1"," totchr_geq4"
"1"," Dead"
"1","
totchr_0   "
"1"," 0.75    "
"1"," 0.15    "
"1","         "
"1","         "
"1","            "
"1"," 0.1 "
"1","
totchr_1   "
"1"," 0.05    "
"1"," 0.7     "
"1"," 0.1     "
"1","         "
"1","            "
"1"," 0.15"
"1","
totchr_2   "
"1","         "
"1"," 0.05    "
"1"," 0.68    "
"1"," 0.12    "
"1","            "
"1"," 0.15"
"1","
totchr_3   "
"1","         "
"1","         "
"1"," 0.05    "
"1"," 0.65    "
"1"," 0.15       "
"1"," 0.15"
"1","
totchr_geq4"
"1","         "
"1","         "
"1","         "
"1"," 0.05    "
"1"," 0.7        "
"1"," 0.25"
"1","
Dead       "
"1","         "
"1","         "
"1","         "
"1","         "
"1","            "
"1"," 1   "
"1","
"
"0","print(""State names in trans_standard:"")"
"1","[1]"
"1"," ""State names in trans_standard:"""
"1","
"
"0","print(attr(trans_standard, ""state_names""))"
"1","[1]"
"1"," ""totchr_0""   "
"1"," ""totchr_1""   "
"1"," ""totchr_2""   "
"1"," ""totchr_3""   "
"1"," ""totchr_geq4"""
"1","
"
"1","[6]"
"1"," ""Dead""       "
"1","
"
"0","print(""Number of states in trans_standard:"")"
"1","[1]"
"1"," ""Number of states in trans_standard:"""
"1","
"
"0","print(length(attr(trans_standard, ""state_names"")))"
"1","[1]"
"1"," 6"
"1","
"
"0","# Transition matrix (intervention: 50% reduced worsening) with state names"
"0","trans_intervention <- define_transition("
"0","  0.825, 0.075, 0,     0,     0,     0.10,  # totchr_0"
"0","  0.05,  0.80,  0.05,  0,     0,     0.10,  # totchr_1"
"0","  0,     0.05,  0.79,  0.06,  0,     0.10,  # totchr_2"
"0","  0,     0,     0.05,  0.725, 0.075, 0.15,  # totchr_3"
"0","  0,     0,     0,     0.05,  0.75,  0.20,  # totchr_geq4"
"0","  0,     0,     0,     0,     0,     1.00,  # Dead"
"0","  state_names = state_names"
"0",")"
"0",""
"0","# Debug: Check transition matrix"
"0","print(""Transition matrix (intervention):"")"
"1","[1]"
"1"," ""Transition matrix (intervention):"""
"1","
"
"0","print(trans_intervention)"
"1","A transition matrix, 6 states.

"
"1","           "
"1"," totchr_0"
"1"," totchr_1"
"1"," totchr_2"
"1"," totchr_3"
"1"," totchr_geq4"
"1"," Dead"
"1","
totchr_0   "
"1"," 0.825   "
"1"," 0.075   "
"1","         "
"1","         "
"1","            "
"1"," 0.1 "
"1","
totchr_1   "
"1"," 0.05    "
"1"," 0.8     "
"1"," 0.05    "
"1","         "
"1","            "
"1"," 0.1 "
"1","
totchr_2   "
"1","         "
"1"," 0.05    "
"1"," 0.79    "
"1"," 0.06    "
"1","            "
"1"," 0.1 "
"1","
totchr_3   "
"1","         "
"1","         "
"1"," 0.05    "
"1"," 0.725   "
"1"," 0.075      "
"1"," 0.15"
"1","
totchr_geq4"
"1","         "
"1","         "
"1","         "
"1"," 0.05    "
"1"," 0.75       "
"1"," 0.2 "
"1","
Dead       "
"1","         "
"1","         "
"1","         "
"1","         "
"1","            "
"1"," 1   "
"1","
"
"0","print(""State names in trans_intervention:"")"
"1","[1]"
"1"," ""State names in trans_intervention:"""
"1","
"
"0","print(attr(trans_intervention, ""state_names""))"
"1","[1]"
"1"," ""totchr_0""   "
"1"," ""totchr_1""   "
"1"," ""totchr_2""   "
"1"," ""totchr_3""   "
"1"," ""totchr_geq4"""
"1","
"
"1","[6]"
"1"," ""Dead""       "
"1","
"
"0","print(""Number of states in trans_intervention:"")"
"1","[1]"
"1"," ""Number of states in trans_intervention:"""
"1","
"
"0","print(length(attr(trans_intervention, ""state_names"")))"
"1","[1]"
"1"," 6"
"1","
"
"0","# Define strategies, explicitly naming states to match state_names (without parameters)"
"0","print(""Defining strategy (standard):"")"
"1","[1]"
"1"," ""Defining strategy (standard):"""
"1","
"
"0","model_standard <- define_strategy("
"0","  transition = trans_standard,"
"0","  totchr_0 = state_totchr_0,"
"0","  totchr_1 = state_totchr_1,"
"0","  totchr_2 = state_totchr_2,"
"0","  totchr_3 = state_totchr_3,"
"0","  totchr_geq4 = state_totchr_geq4,"
"0","  Dead = state_dead"
"0",")"
"0",""
"0","print(""Defining strategy (intervention):"")"
"1","[1]"
"1"," ""Defining strategy (intervention):"""
"1","
"
"0","model_intervention <- define_strategy("
"0","  transition = trans_intervention,"
"0","  totchr_0 = state_totchr_0,"
"0","  totchr_1 = state_totchr_1,"
"0","  totchr_2 = state_totchr_2,"
"0","  totchr_3 = state_totchr_3,"
"0","  totchr_geq4 = state_totchr_geq4,"
"0","  Dead = state_dead"
"0",")"
"0",""
"0","# Run deterministic model, passing parameters here and removing discount"
"0","result <- run_model("
"0","  standard = model_standard,"
"0","  intervention = model_intervention,"
"0","  parameters = params,"
"0","  cycles = 10, # 10 years, suitable for ages 60â€“90"
"0","  method = ""end"","
"0","  cost = cost,    # Explicitly specify cost variable"
"0","  effect = effect  # Explicitly specify effect variable"
"0",")"
"0",""
"0","# Debug: Inspect model outputs"
"0","print(summary(result))"
"1","2 strategies run for 10 cycles.

"
"1","Initial state counts:

"
"1","totchr_0 = 1000L
totchr_1 = 0L
totchr_2 = 0L
totchr_3 = 0L
totchr_geq4 = 0L
Dead = 0L"
"1","

Counting method: 'end'.

"
"1","Values:

"
